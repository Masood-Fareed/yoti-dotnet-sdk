Yoti .NET SDK
=============

Welcome to the Yoti .NET SDK. This repo contains the tools and step by step instructions you need to quickly integrate your .NET back-end with Yoti so that your users can share their identity details with your application in a secure and trusted way.

## Table of Contents

1) [An Architectural view](#an-architectural-view) -
High level overview of integration

1) [Enabling the SDK](#enabling-the-sdk) -
How to install our SDK

1) [Client initialisation](#client-initialisation) -
Description on setting up your SDK

1) [Profile retrieval](#profile-retrieval) -
Description on setting up profile

1) [Handling users](#handling-users) -
Description on handling user log on's

1) [API Coverage](#api-coverage) -
Attributes defined

1) [Support](#support) -
Please feel free to reach out

## An Architectural View

To integrate your application with Yoti, your back-end must expose a GET endpoint that Yoti will use to forward tokens.
The endpoint can be configured in Yoti Dashboard when you create/update your application.

The image below shows how your application back-end and Yoti integrate in the context of a Login flow.
Yoti SDK carries out for you steps 6, 7 ,8 and the profile decryption in step 9.

![alt text](login_flow.png "Login flow")

Yoti also allows you to enable user details verification from your mobile app by means of the Android (TBA) and iOS (TBA) SDKs. In that scenario, your Yoti-enabled mobile app is playing both the role of the browser and the Yoti app. By the way, your back-end doesn't need to handle these cases in a significantly different way. You might just decide to handle the `User-Agent` header in order to provide different responses for web and mobile clients.

## Enabling the SDK

To install the Yoti NuGet package you will need to install NuGet. You can find instructions to do that [here](http://docs.nuget.org/ndocs/guides/install-nuget)

To import the latest Yoti SDK into your project, enter the following command from NuGet Package Manager Console in Visual Studio:

```
Install-Package Yoti
```

For other installation methods, see [nuget.org/packages/Yoti](https://www.nuget.org/packages/Yoti)

To install the [Yoti.Owin package](https://www.nuget.org/packages/Yoti.Owin), you can use:

```
Install-Package Yoti.Owin
```

## Client Initialisation

The YotiClient is the SDK entry point. To initialise it you need include the following snippet inside your endpoint initialisation section:

```cs
const string sdkId = "your-sdk-id";
var privateKeyStream = System.IO.File.OpenText("path/to/your-application-pem-file.pem");
var yotiClient = new YotiClient(sdkId, privateKeyStream);
```

Where:

* `sdkId` is the sdk identifier generated by Yoti Dashboard when you create (and then publish) your app. _Note this is not your Application Identifier which is needed by your clientside code_
* `path/to/your-application-pem-file.pem` - When you create your app on Yoti Dashboard, your browser generates a .pem file. This is the path to that file.

You'll need to add the `Callback URL` of your site to the integration settings section on your [Yoti Applications page](https://www.yoti.com/dashboard/applications). This is where the user will be redirected to upon successful authentication. For the [Example project](src/Example), you should append `/account/connect` to the end of this URL.

## Profile Retrieval

When your application receives a token via the exposed endpoint (it will be assigned to a query string parameter named `token`), you can easily retrieve the user profile by adding the following to your endpoint handler:

```cs
var activityDetails = yotiClient.GetActivityDetails(token);
```

Or if you are in an asynchronous method:

```cs
var activityDetails = await yotiClient.GetActivityDetailsAsync(token);
```

Before you inspect the user profile, you might want to check whether the user validation was successful.
This is done as follows:

```cs
var activityDetails = yotiClient.GetActivityDetails(token);
if (activityDetails.Outcome == ActivityOutcome.Success)
{
    var profile = activityDetails.UserProfile;
}
else
{
    // handle unhappy path
}
```

## Handling Users

When you retrieve the user profile, you receive a user ID generated by Yoti exclusively for your application.
This means that if the same individual logs into another app, Yoti will assign her/him a different ID.
You can use this ID to verify whether (for your application) the retrieved profile identifies a new or an existing user.
Here is an example of how this works:

```cs
var activityDetails = yotiClient.GetActivityDetails(token);
if (activityDetails.Outcome == ActivityOutcome.Success)
{
    var profile = activityDetails.UserProfile;
    var user = YourUserSearchFunction(profile.Id);
    if (user != null)
    {
      string userId = profile.Id;
      Image Selfie = profile.Selfie;
      string SelfieURI = profile.Selfie.Base64URI;
	  string FullName = profile.FullName;
      string GivenNames = profile.GivenNames;
      string FamilyName = profile.FamilyName;
      string MobileNumber = profile.MobileNumber;
      string EmailAddress = profile.EmailAddress;
      DateTime? DateOfBirth = profile.DateOfBirth;
      string Address = profile.Address;
      string Gender = profile.Gender;
      string Nationality = profile.Nationality;
    }
    else
    {
        // handle registration
    }
}
else
{
    // handle unhappy path
}
```

Where `yourUserSearchFunction` is a piece of logic in your app that is supposed to find a user, given a userId.
No matter if the user is a new or an existing one, Yoti will always provide her/his profile, so you don't necessarily need to store it.

The `profile` object provides a set of attributes corresponding to user attributes. Whether the attributes are present or not depends on the settings you have applied to your app on Yoti Dashboard.

## API Coverage

* Activity Details
  * [X] Profile
    * [X] User ID `Id`
    * [X] Selfie `Selfie`
    * [X] Selfie URI `Selfie.Base64URI`
    * [X] Given Names `GivenNames`
    * [X] Family Name `FamilyName`
    * [X] Full Name `FullName`
    * [X] Mobile Number `MobileNumber`
    * [X] Email Address `EmailAddress`
    * [X] Age / Date of Birth `DateOfBirth`
    * [X] Age / Verify Condition `age_[over|under]:[1-999]`
    * [X] Postal Address `Address`
    * [X] Gender `Gender`
    * [X] Nationality `Nationality`
    
## Support

For any questions or support please email [sdksupport@yoti.com](mailto:sdksupport@yoti.com).
Please provide the following to get you up and working as quickly as possible:

* Computer type
* OS version
* Version of .NET being used
* Screenshot

Once we have answered your question we may contact you again to discuss Yoti products and services. If youâ€™d prefer us not to do this, please let us know when you e-mail.

For further documentation, see [https://www.yoti.com/developers/documentation/?csharp](www.yoti.com/developers/documentation/?csharp)
